# 刚性事务与柔性事务

## 刚性事务的定义

刚性事务（如单数据库）完全遵循 `ACID` 规范，即数据库事务正确执行的四个基本要素：

- 原子性（Atomicity）
- 一致性（Consistency）
- 隔离性（Isolation）
- 持久性（Durability）

## 柔性事务的定义

柔性事务（如分布式事务）为了满足可用性、性能与降级服务的需要，降低一致性（Consistency）与隔离性（Isolation）的要求，遵循 `BASE` 理论：

- 基本业务可用性（Basic Availability）
- 柔性状态（Soft state）
- 最终一致性（Eventual consistency）

同样的，柔性事务也部分遵循 `ACID` 规范：

- 原子性：严格遵循
- 一致性：事务完成后的一致性严格遵循；事务中的一致性可适当放宽
- 隔离性：并行事务间不可影响；事务中间结果可见性允许安全放宽
- 持久性：严格遵循

## 刚性事务与柔性事务的实现方案

### 刚性事务

- 两阶段提交

  `XA` 协议（ `2PC、JTA、JTS` ）。二阶段提交的算法思路可以概括为：每个参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报，决定各参与者是否要提交操作还是中止操作。

- 3PC

  三阶段提交协议（ `Three-phase commit protocol` ），是二阶段提交（ `2PC` ）的改进版本。三个阶段分别是：询问，然后再锁资源，最后真正提交。

> 刚性事务推荐 `XA` 实现。

### 柔性事务

- 补偿型（TCC/FMT）

  `TCC` 型事务（ `Try-Confirm-Cancel` ）可以归为补偿型。在 `Try` 成功的情况下，如果事务要回滚，`Cancel` 将作为一个补偿机制，回滚 `Try` 操作；`TCC` 各操作事务本地化，且尽早提交（没有两阶段约束）；当全局事务要求回滚时，通过另一个本地事务实现 `“补偿”` 行为。

  `TCC` 是将资源层的二阶段提交协议转换到业务层，成为业务模型中的一部分。

- 本地消息表

    本地消息表最初是由 `eBay` 架构师 `DanPritchett` 在一篇解释 `BASE` 原理的论文[《Base：An Acid Alternative》](https://queue.acm.org/detail.cfm?id=1394128)中提及的，业界目前使用这种方案是比较多的，其核心思想是将分布式事务拆分成本地事务进行处理。

    方案通过在事务主动发起方额外新建事务消息表，事务发起方处理业务和记录事务消息在本地事务中完成，轮询事务消息表的数据发送事务消息，事务被动方基于消息中间件消费事务消息表中的事务。

- 异步确保型（事务消息）

  将一些有同步冲突的事务操作变为异步操作，避免对数据库事务的争用，如事务消息机制。

- SAGA 事务模型（状态机模式、Aop 模式）

  `Saga` 模型是把一个分布式事务拆分为多个本地事务，每个本地事务都有相应的执行模块和补偿模块（对应 `TCC` 中的 `Confirm` 和 `Cancel` ），当 `Saga` 事务中任意一个本地事务出错时，可以通过调用相关的补偿方法恢复之前的事务，达到事务最终一致性。

- 最大努力通知型

  通过通知服务器（消息通知）进行，允许失败，有补充机制。

> 柔性事务通常推荐同步 `Saga`、异步事务消息

## 分布式事务对比

|          | 本地事务         | 刚性事务        | 柔性事务        |
| -------- | ---------------- | --------------- | --------------- |
| 业务改造 | 无               | 无              | 实现相关接口    |
| 一致性   | 不支持           | 支持            | 最终一致        |
| 隔离性   | 不支持           | 支持            | 业务方保证      |
| 并发性能 | 无影响           | 严重衰退        | 略微衰退        |
| 适合场景 | 业务方处理不一致 | 短事务 & 低并发 | 长事务 & 高并发 |

## 参考

- [柔性事务的定义与分类](https://tech.antfin.com/docs/2/69656)

- [传统事务与柔性事务](https://www.jianshu.com/p/ab1a1c6b08a1)

- [分布式架构设计篇(七)-刚性事务总结和柔性事务概述](https://cloud.tencent.com/developer/article/1653146)

- [分布式架构设计篇(十二)-分布式事务总结篇](https://cloud.tencent.com/developer/article/1659326)

- [浅谈事务和一致性：刚性 or 柔性？](https://juejin.cn/post/6844903575756210184)
