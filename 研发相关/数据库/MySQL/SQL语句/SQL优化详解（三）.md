# MySql 优化详解（三）查询性能优化

## 慢查询优化

#### 优化数据访问

> 分析方式：
    - 确认应用程序是否在检索大量超过需要的数据。
    - 确认MySQL服务器层是否在分析大量超过需要的数据行。

- 是否请求了不需要的数据

    - 查询不需要的记录
    - 多表关联时返回全部列
    - 总是取出全部列
    - 重复查询相同的数据

- `MySQL` 是否在扫描额外的记录

    > 对于 `MySQL` ，最简单的衡量查询开销的三个指标：`响应时间`，`扫描的行数`，`返回的行数`。这三个指标都会记录到 `MySQL` 的慢 `SQL` 日志中。

#### 重构查询的方式

- 一个复杂查询还是多个简单查询

- 切分查询

    如果一个大的语句一次性完成，则可能需要一次锁住很多数据、占满整个事务日志。耗尽系统资源、阻塞很多小的但很重要的查询。

- 分解关联查询

    优势：
    - 让缓存的效率更高
    - 将查询分解后，执行单个查询可以减少锁的竞争
    - 在应用层做关联，可以更容易对数据库进行拆分，跟容易做到高性能和可扩展
    - 查询本身效率也可能会提升
    - 减少冗余记录的查询

#### 查询执行的基础

MySQL查询过程：

![mark](http://of0qa2hzs.bkt.clouddn.com/blog/171229/6dFiAEL71j.png?imageslim)

- MySQL客户端/服务器通信协议

    MySQL客户端和服务器之间的通信协议是 `半双工` 的，所以，在任何一个时刻，要么是由服务器向客户端发送数据，要么是由客户端向服务器发送数据。因而在实际开发中，尽量保持查询简单且只返回必需的数据，减小通信间数据包的大小和数量是一个非常好的习惯，这也是查询中尽量避免使用 `SELECT *` 以及加上 `LIMIT` 限制的原因之一。

    - 查询状态
        > 对于一个MySQL连接，或者说一个线程，任何时刻都有一个状态，该状态表示了MySQL当前正在做什么（SHOW FULL PROCESSLIST）。
        - Sleep

            线程正在等待客户端发送新的请求
        - Query

            线程正在执行查询或者正在将结果发送给客户端
        - Locked

            在MySQL服务器层，该线程正在等待表锁
        - Analyzing and statistics

            线程正在收集存储引擎的统计信息，并生成查询的执行计划。
        - Copying to tem table [on disk]

            线程正在执行查询，并且将其结果集都复制到一个临时表中

- 查询缓存

- 查询优化处理

#### MySQL查询优化器的局限性

#### 查询优化器的提示

#### 优化特定类型的查询